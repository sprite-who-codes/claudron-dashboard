<!--
  ============================================================================
  File:     dashboard/index.html
  Purpose:  Claudron Dashboard ‚Äî "Claudron lives here"

  The main display for a 7" screen (1024√ó600). Shows Claudron's sprite in
  whatever room he's currently in, with mood-based face rendering, speech
  bubble for status text, and smooth animations.

  Polls /api/state every 2s for mood, status, room, and location changes.
  Polls /api/room/{room} when the room changes to get location configs.

  External Dependencies:
    /js/claudron-face.js                ‚Äî Shared face rendering (renderFace)
    /sprites/body-final-transparent.png ‚Äî Sprite body image
    /rooms/{room}/wallpaper.png         ‚Äî Room background images
  ============================================================================
-->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Claudron</title>
<style>
  /* ===== Reset & Base ===== */
  * { margin: 0; padding: 0; box-sizing: border-box; }
  .cursor-hidden, .cursor-hidden * { cursor: none !important; }
  body {
    background: #0f0f0f;
    overflow: hidden;
    width: 100vw;
    height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }

  /* ===== Pixel Font ===== */
  @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');

  /* ===== Top Decorative Border =====
     Cozy cottage shelf with pixel art items ‚Äî vines, books, potions.
     Fills the black bar above the room. */
  #top-border {
    width: 100%;
    max-width: 1584px;
    height: 83px;
    background: #1a1208;
    position: relative;
    overflow: hidden;
    image-rendering: pixelated;
    flex-shrink: 0;
  }

  /* Wooden shelf base */
  #top-border::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 8px;
    background: linear-gradient(to bottom, #8B6914, #6B4F10, #4A3508);
    box-shadow: 0 2px 4px rgba(0,0,0,0.6);
  }

  /* Shelf top highlight */
  #top-border::before {
    content: '';
    position: absolute;
    bottom: 8px;
    left: 0;
    right: 0;
    height: 2px;
    background: #A67C1A;
    z-index: 1;
  }

  /* Shelf items container */
  .shelf-items {
    position: absolute;
    bottom: 10px;
    left: 0;
    right: 0;
    height: 70px;
    display: flex;
    align-items: flex-end;
    justify-content: space-around;
    padding: 0 20px;
  }

  /* Individual shelf item base */
  .shelf-item {
    position: relative;
    image-rendering: pixelated;
    flex-shrink: 0;
  }

  /* --- Pixel art book cluster --- */
  .books {
    display: flex;
    align-items: flex-end;
    gap: 2px;
  }
  .book {
    width: 8px;
    border-radius: 1px 1px 0 0;
  }
  .book-red { height: 28px; background: #C0392B; border-left: 2px solid #A93226; }
  .book-blue { height: 32px; background: #2E86C1; border-left: 2px solid #2471A3; }
  .book-green { height: 26px; background: #27AE60; border-left: 2px solid #1E8449; }
  .book-purple { height: 30px; background: #8E44AD; border-left: 2px solid #7D3C98; }
  .book-brown { height: 24px; background: #A0522D; border-left: 2px solid #8B4513; }
  .book-teal { height: 34px; background: #17A589; border-left: 2px solid #148F77; }
  .book-tilted {
    width: 8px;
    height: 30px;
    background: #D4AC0D;
    border-left: 2px solid #B7950B;
    transform: rotate(15deg);
    transform-origin: bottom right;
    margin-right: 4px;
  }

  /* --- Pixel art potion bottles --- */
  .potion {
    width: 14px;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .potion-neck {
    width: 6px;
    height: 8px;
    border-radius: 2px 2px 0 0;
  }
  .potion-body {
    width: 14px;
    height: 18px;
    border-radius: 0 0 4px 4px;
  }
  .potion-cork {
    width: 8px;
    height: 4px;
    background: #A0522D;
    border-radius: 2px 2px 0 0;
  }
  .potion-green .potion-neck { background: rgba(46, 204, 113, 0.6); }
  .potion-green .potion-body { background: #2ECC71; box-shadow: 0 0 6px rgba(46, 204, 113, 0.5); }
  .potion-purple .potion-neck { background: rgba(155, 89, 182, 0.6); }
  .potion-purple .potion-body { background: #9B59B6; box-shadow: 0 0 6px rgba(155, 89, 182, 0.5); }
  .potion-blue .potion-neck { background: rgba(52, 152, 219, 0.6); }
  .potion-blue .potion-body { background: #3498DB; box-shadow: 0 0 6px rgba(52, 152, 219, 0.4); }
  .potion-red .potion-neck { background: rgba(231, 76, 60, 0.6); }
  .potion-red .potion-body { background: #E74C3C; box-shadow: 0 0 6px rgba(231, 76, 60, 0.4); }

  /* --- Vine decorations --- */
  .vine {
    position: absolute;
    color: #27AE60;
    font-size: 24px;
    top: 8px;
    text-shadow: 0 0 4px rgba(39, 174, 96, 0.3);
  }
  .vine-left { left: 8px; }
  .vine-right { right: 8px; transform: scaleX(-1); }

  /* --- Candle --- */
  .candle {
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .candle-flame {
    width: 6px;
    height: 10px;
    background: #F39C12;
    border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
    box-shadow: 0 0 8px #F39C12, 0 0 16px rgba(243, 156, 18, 0.4);
    animation: flicker 1.5s ease-in-out infinite alternate;
  }
  .candle-wax {
    width: 10px;
    height: 22px;
    background: #F5E6CA;
    border-radius: 2px;
  }
  .candle-holder {
    width: 16px;
    height: 4px;
    background: #8B6914;
    border-radius: 0 0 2px 2px;
  }

  @keyframes flicker {
    0% { transform: scaleY(1) scaleX(1); opacity: 1; }
    25% { transform: scaleY(1.1) scaleX(0.9); }
    50% { transform: scaleY(0.9) scaleX(1.1); opacity: 0.85; }
    75% { transform: scaleY(1.05) scaleX(0.95); }
    100% { transform: scaleY(0.95) scaleX(1.05); opacity: 0.9; }
  }

  /* --- Crystal ball --- */
  .crystal-ball {
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .crystal-orb {
    width: 22px;
    height: 22px;
    border-radius: 50%;
    background: radial-gradient(circle at 35% 35%, rgba(155, 89, 182, 0.3), #2C1A4A 70%);
    border: 2px solid #7D3C98;
    box-shadow: 0 0 10px rgba(155, 89, 182, 0.4), inset 0 0 8px rgba(155, 89, 182, 0.2);
    animation: crystalGlow 3s ease-in-out infinite;
  }
  .crystal-base {
    width: 18px;
    height: 6px;
    background: #8B6914;
    border-radius: 0 0 4px 4px;
    margin-top: -2px;
  }

  @keyframes crystalGlow {
    0%, 100% { box-shadow: 0 0 10px rgba(155, 89, 182, 0.4), inset 0 0 8px rgba(155, 89, 182, 0.2); }
    50% { box-shadow: 0 0 16px rgba(155, 89, 182, 0.7), inset 0 0 12px rgba(155, 89, 182, 0.4); }
  }

  /* --- Skull decoration --- */
  .skull {
    font-size: 20px;
    filter: grayscale(0.3);
  }

  /* --- Plant --- */
  .plant {
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .plant-leaves {
    font-size: 18px;
    line-height: 1;
    margin-bottom: -4px;
  }
  .plant-pot {
    width: 16px;
    height: 12px;
    background: #A0522D;
    border-radius: 0 0 4px 4px;
    border-top: 2px solid #8B4513;
  }

  /* ===== Bottom HUD Strip =====
     Retro game stats panel with live info. */
  #bottom-hud {
    width: 100%;
    max-width: 1584px;
    height: 83px;
    background: linear-gradient(to bottom, #1a1412, #0f0d0b);
    border-top: 2px solid #3d2e1f;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 24px;
    font-family: 'VT323', monospace;
    color: #c8b89a;
    position: relative;
  }

  /* HUD decorative top edge */
  #bottom-hud::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg,
      transparent 0%, #6B4F10 10%, #A67C1A 30%,
      #A67C1A 70%, #6B4F10 90%, transparent 100%
    );
  }

  /* HUD section containers */
  .hud-section {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
  }

  .hud-label {
    font-size: 14px;
    color: #6b5d4d;
    text-transform: uppercase;
    letter-spacing: 2px;
  }

  .hud-value {
    font-size: 28px;
    color: #e8d8c0;
    text-shadow: 0 0 6px rgba(232, 216, 192, 0.3);
  }

  .hud-value-small {
    font-size: 20px;
    color: #c8b89a;
  }

  /* Mood emoji display */
  .hud-mood {
    font-size: 36px;
    line-height: 1;
    filter: drop-shadow(0 0 4px rgba(155, 89, 182, 0.4));
  }

  /* Room name with accent color */
  .hud-room {
    font-size: 24px;
    color: #A78BFA;
    text-shadow: 0 0 8px rgba(167, 139, 250, 0.3);
  }

  /* Weather section */
  .hud-weather {
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .hud-weather-icon {
    font-size: 28px;
  }
  .hud-weather-temp {
    font-size: 24px;
    color: #e8d8c0;
  }

  /* Divider lines between HUD sections */
  .hud-divider {
    width: 1px;
    height: 50px;
    background: linear-gradient(to bottom, transparent, #3d2e1f, transparent);
  }

  /* ===== Room Container =====
     Maintains native wallpaper aspect ratio (1584√ó672 ‚Üí 42.42%).
     Fills width, centered vertically. Now flanked by borders. */
  #room-container {
    position: relative;
    width: 100%;
    max-width: 1584px;
    flex: 1;
    min-height: 0;
  }
  #room-wallpaper {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    object-fit: cover;
    transition: opacity 0.5s ease;
  }

  /* ===== Sprite Anchor =====
     Absolutely positioned within room container.
     Transitions smoothly when location changes. */
  #sprite-anchor {
    position: absolute;
    display: none;
    flex-direction: column;
    align-items: center;
    transition: left 0.6s ease, top 0.6s ease;
  }

  /* ===== Speech Bubble (Stardew/Animal Crossing style) ===== */
  #speech-bubble {
    position: absolute;
    z-index: 10;
    background: rgba(245, 240, 230, 0.95);
    border: 2.5px solid #8B6FCF;
    border-radius: 14px;
    padding: 7px 14px;
    max-width: 400px;
    white-space: nowrap;
    transform: translateX(-50%);
    font-family: 'VT323', monospace;
    font-size: 12px;
    letter-spacing: 0.5px;
    line-height: 1.3;
    color: #2a1a3e;
    text-align: center;
    box-shadow: 0 2px 8px rgba(139, 111, 207, 0.3), inset 0 0 0 1px rgba(255,255,255,0.3);
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
  }
  #speech-bubble.visible { opacity: 1; }
  /* Cute rounded tail */
  #speech-bubble::after {
    content: '';
    position: absolute;
    bottom: -7px;
    left: 50%;
    transform: translateX(-50%) rotate(45deg);
    width: 10px; height: 10px;
    background: rgba(245, 240, 230, 0.95);
    border-right: 2.5px solid #8B6FCF;
    border-bottom: 2.5px solid #8B6FCF;
  }

  /* ===== Sprite Wrapper ===== */
  #sprite-wrap {
    position: relative;
    width: 200px;
    height: 183px;
    transform-origin: top center;
  }
  #sprite-wrap img {
    position: absolute;
    top: 0; left: 0;
    width: 200px; height: 183px;
  }
  #face-container {
    position: absolute;
    top: 0; left: 0;
    width: 200px; height: 183px;
    pointer-events: none;
  }

  /* ===== Animations ===== */
  @keyframes bob {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-5px); }
  }
  @keyframes glowGreen {
    0%, 100% { filter: drop-shadow(0 0 8px rgba(74, 222, 128, 0.65)); }
    50% { filter: drop-shadow(0 0 18px rgba(74, 222, 128, 0.85)); }
  }
  @keyframes glowRed {
    0%, 100% { filter: drop-shadow(0 0 8px rgba(255, 68, 68, 0.65)); }
    50% { filter: drop-shadow(0 0 18px rgba(255, 68, 68, 0.85)); }
  }

  /* Mood-based sprite states */
  .mood-normal #sprite-anchor { animation: bob 3s ease-in-out infinite; }
  .mood-normal #sprite-wrap  { animation: glowGreen 3s ease-in-out infinite; }

  .mood-angry #sprite-anchor { animation: bob 3s ease-in-out infinite; }
  .mood-angry #sprite-wrap   { animation: glowRed 3s ease-in-out infinite; }

  .mood-sleeping #sprite-anchor { animation: none; }
  .mood-sleeping #sprite-wrap   { animation: none; filter: none; opacity: 0.6; }

  /* ===== Editor Toggle ===== */
  .corner-btn {
    position: fixed;
    bottom: 95px;
    width: 36px;
    height: 36px;
    background: rgba(30, 30, 30, 0.7);
    border: 1px solid #333;
    border-radius: 50%;
    color: #888;
    font-size: 18px;
    cursor: pointer;
    z-index: 100;
    display: flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    transition: opacity 0.3s;
    opacity: 0.4;
  }
  .corner-btn:hover { opacity: 1; }
  #editor-btn { right: 10px; }
  #fullscreen-btn { right: 54px; }
</style>
</head>
<body>

<!-- ===== Top Decorative Border ‚Äî Cozy Cottage Shelf ===== -->
<div id="top-border">
  <span class="vine vine-left">üåø</span>
  <span class="vine vine-right">üåø</span>
  <div class="shelf-items">
    <!-- Left cluster: plant + books -->
    <div class="shelf-item plant">
      <div class="plant-leaves">üå±</div>
      <div class="plant-pot"></div>
    </div>
    <div class="shelf-item books">
      <div class="book book-tilted"></div>
      <div class="book book-red"></div>
      <div class="book book-blue"></div>
      <div class="book book-green"></div>
    </div>
    <div class="shelf-item potion potion-green">
      <div class="potion-cork"></div>
      <div class="potion-neck"></div>
      <div class="potion-body"></div>
    </div>
    <!-- Center cluster: candle + crystal ball -->
    <div class="shelf-item candle">
      <div class="candle-flame"></div>
      <div class="candle-wax"></div>
      <div class="candle-holder"></div>
    </div>
    <div class="shelf-item books">
      <div class="book book-purple"></div>
      <div class="book book-brown"></div>
      <div class="book book-teal"></div>
    </div>
    <div class="shelf-item crystal-ball">
      <div class="crystal-orb"></div>
      <div class="crystal-base"></div>
    </div>
    <div class="shelf-item potion potion-purple">
      <div class="potion-cork"></div>
      <div class="potion-neck"></div>
      <div class="potion-body"></div>
    </div>
    <!-- Right cluster: skull + books + potions -->
    <div class="shelf-item skull">üíÄ</div>
    <div class="shelf-item books">
      <div class="book book-red"></div>
      <div class="book book-purple"></div>
      <div class="book book-tilted"></div>
    </div>
    <div class="shelf-item potion potion-blue">
      <div class="potion-cork"></div>
      <div class="potion-neck"></div>
      <div class="potion-body"></div>
    </div>
    <div class="shelf-item candle">
      <div class="candle-flame"></div>
      <div class="candle-wax"></div>
      <div class="candle-holder"></div>
    </div>
    <div class="shelf-item potion potion-red">
      <div class="potion-cork"></div>
      <div class="potion-neck"></div>
      <div class="potion-body"></div>
    </div>
    <div class="shelf-item plant">
      <div class="plant-leaves">ü™¥</div>
      <div class="plant-pot"></div>
    </div>
  </div>
</div>

<!-- ===== Room View ===== -->
<div id="room-container">
  <img id="room-wallpaper" src="" alt="">
  <div id="speech-bubble"></div>
  <div id="sprite-anchor">
    <div id="sprite-wrap">
      <img id="sprite" src="/sprites/body-final-transparent.png" alt="">
      <div id="face-container"></div>
    </div>
  </div>
</div>

<!-- ===== Bottom HUD ‚Äî Retro Game Stats Panel ===== -->
<div id="bottom-hud">
  <div class="hud-section">
    <div class="hud-label">Time</div>
    <div class="hud-value" id="hud-time">--:--</div>
    <div class="hud-value-small" id="hud-date">---</div>
  </div>
  <div class="hud-divider"></div>
  <div class="hud-section">
    <div class="hud-label">Weather</div>
    <div class="hud-weather">
      <span class="hud-weather-icon" id="hud-weather-icon">üå§Ô∏è</span>
      <span class="hud-weather-temp" id="hud-weather-temp">--¬∞</span>
    </div>
  </div>
  <div class="hud-divider"></div>
  <div class="hud-section">
    <div class="hud-label">Mood</div>
    <div class="hud-mood" id="hud-mood">üò¥</div>
  </div>
  <div class="hud-divider"></div>
  <div class="hud-section">
    <div class="hud-label">Room</div>
    <div class="hud-room" id="hud-room">---</div>
  </div>
</div>

<!-- Controls -->
<button id="fullscreen-btn" class="corner-btn" title="Toggle Fullscreen">‚õ∂</button>
<a id="editor-btn" class="corner-btn" href="/editor.html" title="Open Editor">‚öôÔ∏è</a>

<script src="/js/claudron-face.js"></script>
<script>
  // =========================================================================
  //  Constants & State
  // =========================================================================
  const NATIVE_W = 1584, SPRITE_NATIVE = 250;

  let currentRoom = null;
  let currentLoc = null;
  let currentMood = null;
  let currentStatus = null;
  let roomConfig = null;

  // DOM refs
  const container = document.getElementById('room-container');
  const wallpaper = document.getElementById('room-wallpaper');
  const anchor    = document.getElementById('sprite-anchor');
  const wrap      = document.getElementById('sprite-wrap');
  const faceCtr   = document.getElementById('face-container');
  const bubble    = document.getElementById('speech-bubble');

  // =========================================================================
  //  Mood Class Management
  // =========================================================================

  /** Apply the correct mood class to <body> for CSS animation control. */
  function applyMoodClass(mood) {
    document.body.className = '';
    if (mood === 'sleeping') {
      document.body.classList.add('mood-sleeping');
    } else if (mood === 'angry') {
      document.body.classList.add('mood-angry');
    } else {
      document.body.classList.add('mood-normal');
    }
  }

  // =========================================================================
  //  Sprite Positioning
  // =========================================================================

  /**
   * Position the sprite at a location from the room config.
   * Uses the exact positioning math from the spec.
   */
  function positionSprite(loc) {
    if (!loc) { anchor.style.display = 'none'; return; }

    const containerWidth = container.offsetWidth;
    const spritePct = SPRITE_NATIVE / NATIVE_W * 100;
    const scale = (containerWidth * spritePct / 100) / 200;
    const scaledW = 200 * scale;
    const scaledH = 183 * scale;

    const facing = loc.facing || 'right';
    const rotation = loc.rotation || 0;

    anchor.style.display = 'flex';
    anchor.style.left = `calc(${loc.x * 100}% - ${scaledW / 2}px)`;
    anchor.style.top = `calc(${loc.y * 100}% - ${scaledH}px)`;
    // Position bubble centered above sprite's mouth area
    bubble.style.left = `calc(${loc.x * 100}% + ${scaledW * 0.16}px)`;
    bubble.style.top = `calc(${loc.y * 100}% - ${scaledH + 30}px)`;
    wrap.style.transform = `scale(${scale})${facing === 'left' ? ' scaleX(-1)' : ''}${rotation ? ` rotate(${rotation}deg)` : ''}`;
    wrap.style.transformOrigin = 'top center';
  }

  // =========================================================================
  //  Speech Bubble
  // =========================================================================

  function updateBubble(status) {
    if (status) {
      bubble.textContent = status;
      bubble.classList.add('visible');
    } else {
      bubble.classList.remove('visible');
    }
  }

  // =========================================================================
  //  Room Loading
  // =========================================================================

  async function loadRoom(room) {
    wallpaper.src = `/rooms/${room}/wallpaper.png`;
    try {
      const res = await fetch(`/api/room/${room}`);
      roomConfig = await res.json();
    } catch {
      roomConfig = { locations: {} };
    }
  }

  // =========================================================================
  //  State Polling ‚Äî every 2 seconds
  // =========================================================================

  async function pollState() {
    try {
      const res = await fetch('/api/state');
      const state = await res.json();

      // Room changed? Reload room config
      if (state.room !== currentRoom) {
        currentRoom = state.room;
        await loadRoom(currentRoom);
      }

      // Location changed? Reposition sprite
      if (state.location !== currentLoc) {
        currentLoc = state.location;
        const loc = roomConfig?.locations?.[currentLoc];
        positionSprite(loc || null);
      }

      // Mood changed? Update face + animations
      if (state.mood !== currentMood) {
        currentMood = state.mood;
        applyMoodClass(currentMood);
        renderFace(faceCtr, currentMood);
      }

      // Status changed? Update speech bubble
      if (state.status !== currentStatus) {
        currentStatus = state.status;
        updateBubble(currentStatus);
      }

      // Update HUD with current mood and room
      updateHud(state.mood, state.room);
    } catch {
      // Silent fail ‚Äî retry next poll
    }
  }

  // =========================================================================
  //  Resize Handler ‚Äî reposition sprite when window resizes
  // =========================================================================
  let resizeTimer;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(() => {
      if (currentLoc && roomConfig?.locations?.[currentLoc]) {
        positionSprite(roomConfig.locations[currentLoc]);
      }
    }, 100);
  });

  // =========================================================================
  //  Fullscreen Toggle
  // =========================================================================
  const fsBtn = document.getElementById('fullscreen-btn');
  fsBtn.addEventListener('click', () => {
    const el = document.documentElement;
    const isFullscreen = document.fullscreenElement || document.webkitFullscreenElement;
    if (!isFullscreen) {
      (el.requestFullscreen || el.webkitRequestFullscreen || el.msRequestFullscreen).call(el).catch(e => console.error('Fullscreen error:', e));
    } else {
      (document.exitFullscreen || document.webkitExitFullscreen || document.msExitFullscreen).call(document).catch(e => console.error('Exit fullscreen error:', e));
    }
  });
  ['fullscreenchange', 'webkitfullscreenchange'].forEach(evt =>
  document.addEventListener(evt, () => {
    const isFs = document.fullscreenElement || document.webkitFullscreenElement;
    fsBtn.textContent = isFs ? '‚õ∂' : '‚õ∂';
    // Hide controls in fullscreen after a delay, show on mouse move
    if (isFs) {
      fsBtn.style.opacity = '0';
      document.getElementById('editor-btn').style.opacity = '0';
      document.body.classList.add('cursor-hidden');
    } else {
      fsBtn.style.opacity = '';
      document.getElementById('editor-btn').style.opacity = '';
      document.body.classList.remove('cursor-hidden');
    }
    // Reposition sprite after fullscreen transition settles
    setTimeout(() => {
      if (currentLoc && roomConfig?.locations?.[currentLoc]) {
        positionSprite(roomConfig.locations[currentLoc]);
      }
    }, 300);
  }));
  // Show controls on mouse move in fullscreen
  let hideTimer;
  document.addEventListener('mousemove', () => {
    const isFs = document.fullscreenElement || document.webkitFullscreenElement;
    if (isFs) {
      document.body.classList.remove('cursor-hidden');
      fsBtn.style.opacity = '0.4';
      document.getElementById('editor-btn').style.opacity = '0.4';
      clearTimeout(hideTimer);
      hideTimer = setTimeout(() => {
        const stillFs = document.fullscreenElement || document.webkitFullscreenElement;
        if (stillFs) {
          fsBtn.style.opacity = '0';
          document.getElementById('editor-btn').style.opacity = '0';
          document.body.classList.add('cursor-hidden');
        }
      }, 2000);
    }
  });

  // =========================================================================
  //  HUD ‚Äî Bottom Info Strip
  // =========================================================================

  const MOOD_EMOJI = {
    happy: 'üòä', thinking: 'ü§î', sleeping: 'üò¥', angry: 'üò†',
    excited: 'ü§©', sad: 'üò¢', focused: 'üéØ', coding: 'üíª'
  };

  const hudTime = document.getElementById('hud-time');
  const hudDate = document.getElementById('hud-date');
  const hudMood = document.getElementById('hud-mood');
  const hudRoom = document.getElementById('hud-room');

  /** Update the HUD clock every second. */
  function updateClock() {
    const now = new Date();
    const h = now.getHours();
    const m = String(now.getMinutes()).padStart(2, '0');
    const ampm = h >= 12 ? 'PM' : 'AM';
    const h12 = h % 12 || 12;
    hudTime.textContent = `${h12}:${m} ${ampm}`;

    const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    hudDate.textContent = `${days[now.getDay()]} ${months[now.getMonth()]} ${now.getDate()}`;
  }

  /** Update HUD mood and room from state data. */
  function updateHud(mood, room) {
    hudMood.textContent = MOOD_EMOJI[mood] || 'üîÆ';
    hudRoom.textContent = room || '---';
  }

  // Start clock
  updateClock();
  setInterval(updateClock, 1000);

  // =========================================================================
  //  Weather Polling ‚Äî every 15 minutes
  // =========================================================================

  const hudWeatherIcon = document.getElementById('hud-weather-icon');
  const hudWeatherTemp = document.getElementById('hud-weather-temp');

  async function pollWeather() {
    try {
      const res = await fetch('/api/weather');
      const data = await res.json();
      if (data.temp_f !== null && data.temp_f !== undefined) {
        hudWeatherIcon.textContent = data.icon || 'üå°Ô∏è';
        hudWeatherTemp.textContent = `${data.temp_f}¬∞`;
      }
    } catch {
      // Keep showing previous value or "--¬∞"
    }
  }

  // =========================================================================
  //  Init
  // =========================================================================
  pollState();
  setInterval(pollState, 2000);
  pollWeather();
  setInterval(pollWeather, 15 * 60 * 1000);
</script>
</body>
</html>
